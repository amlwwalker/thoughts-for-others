<!DOCTYPE html>
<html>
  <head>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
    </style>
    <link rel="shortcut icon" href="france.ico" />
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script src="sweetalert.min.js"></script> 
    <link rel="stylesheet" type="text/css" href="sweetalert.css">
  </head>
  <body>
    <div id="map"></div>
  </body>
  <script type="text/javascript">
  $(document).ready(function() {
  	google.maps.event.addDomListener(window, 'load', getLocation);  
  })
var snazzyMap = [{"featureType":"all","elementType":"labels.text.fill","stylers":[{"saturation":36},{"color":"#000000"},{"lightness":40}]},{"featureType":"all","elementType":"labels.text.stroke","stylers":[{"visibility":"on"},{"color":"#000000"},{"lightness":16}]},{"featureType":"all","elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"administrative","elementType":"geometry.fill","stylers":[{"color":"#000000"},{"lightness":20}]},{"featureType":"administrative","elementType":"geometry.stroke","stylers":[{"color":"#000000"},{"lightness":17},{"weight":1.2}]},{"featureType":"landscape","elementType":"geometry","stylers":[{"color":"#000000"},{"lightness":20}]},{"featureType":"poi","elementType":"geometry","stylers":[{"color":"#000000"},{"lightness":21}]},{"featureType":"road.highway","elementType":"geometry.fill","stylers":[{"color":"#000000"},{"lightness":17}]},{"featureType":"road.highway","elementType":"geometry.stroke","stylers":[{"color":"#000000"},{"lightness":29},{"weight":0.2}]},{"featureType":"road.arterial","elementType":"geometry","stylers":[{"color":"#000000"},{"lightness":18}]},{"featureType":"road.local","elementType":"geometry","stylers":[{"color":"#000000"},{"lightness":16}]},{"featureType":"transit","elementType":"geometry","stylers":[{"color":"#000000"},{"lightness":19}]},{"featureType":"water","elementType":"geometry","stylers":[{"color":"#0f252e"},{"lightness":17}]}];
function getLocation() {
	swal({   
		title: "Thinking of France",   
		text: "This app is to show the people of France that we are thinking of them. Share your location to help show them",   
		imageUrl: 'france.png',   
		showCancelButton: true,
		closeOnConfirm: false, 
		closeOnCancel: false, 
		showLoaderOnConfirm: true,
		}, function(isConfirm){   
			if (isConfirm) {     
				swal({   
					title: 'Thanks! We are just populating the map',   
					text: 'Come back later and see how we are doing!',   
					timer: 8000 });
			    if (navigator.geolocation) {
			        navigator.geolocation.getCurrentPosition(initMap);
			    } else {
			        swal("Error", "For some reason we can't get your location, sorry", "error");
			    }
			} else {     
				swal("Cancelled", "We need your location so thanks anyway", "error");
			}
	});
}

//simple store to keep the data
var storageLocation = "https://api.decoded.com/store/thinkingoffrance";

function initMap(position) {

	// center: {lat: -33.9, lng: 151.2}
	var latLng = {lat: position.coords.latitude, lng: position.coords.longitude};
  	$.get(storageLocation+"?lat="+latLng.lat+"&lng="+latLng.lng, function() {
  		console.log("stored")
  	})
  var map = new google.maps.Map(document.getElementById('map'), {
    zoom: 3,
    center: latLng,
    styles : snazzyMap
  });

  setMarkers(map);
  
}


// Data for the markers consisting of a name, a LatLng and a zIndex for the
// order in which these markers should display on top of each other.

var markers = [];
function setMarkers(map) {
  // Adds markers to the map.
var redColor = "rgb(255, 0, 0)";
var redStrength = 0.8;
var redSize = 10;

// This is what a neutral tweet will look like
var whiteColor = "rgb(255, 255, 255)";
var whiteStrength = 0.8;
var whiteSize = 10;

// This is  what a negative tweet will look like
var blueColour = "rgb(0, 0, 255)";
var blueStrength = 0.8;
var blueSize = 10;

var icon = {
      path: google.maps.SymbolPath.CIRCLE,
      scale: redSize,
      fillOpacity: redStrength,
      fillColor: redColor,
      strokeWeight: 0
      }


  google.maps.event.addListener(map, 'idle', function(ev) {
  	clearMarkers()
  	var latEast = map.getBounds().getNorthEast().lat();
	var lngEast = map.getBounds().getNorthEast().lng();
	var latWest = map.getBounds().getSouthWest().lat();
	var lngWest = map.getBounds().getSouthWest().lng();
	var width = lngEast - lngWest;
	var third = width / 3;
	//get the data from the store to plot
	$.getJSON(storageLocation, function(data) {
		$.each(data, function(i, d) {
            var lat =d.lat;
			var lng = d.lng;
			if (lng < lngWest || lng > lngEast) {
				return true
			} else if (lat < latWest || lat > latEast) {
				return true	
			}
			if ( lng < lngWest + third ) {
				icon.fillColor = blueColor
			} else if ( lng > lngWest + third && lng < lngWest + 2*third ) {
				icon.fillColor = whiteColor
			} else {
				icon.fillColor = redColour
			}
			var marker = new google.maps.Marker({
	        // Set the position of the marker
	        position: new google.maps.LatLng(lat, lng),
	        // Put the marker on a Google map
	        map: map,
	        icon: icon
	      });
			markers.push(marker)
        });
	});

  });
}

// Removes the markers from the map, but keeps them in the array.
function clearMarkers() {
  setMapOnAll(null);
}
function setMapOnAll(map) {
  for (var i = 0; i < markers.length; i++) {
    markers[i].setMap(map);
  }
}
</script>
</html>